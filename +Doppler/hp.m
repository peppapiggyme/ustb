function [iqhp,vThresh] = hp(iq,v)

import CoherentCompounding.Doppler.*

[packet,ranges,beams] = size(iq);

switch v.typeFilter
    case 'polyreg'
        % Fm = CoherentCompounding.Doppler.polyregMatrix(v.packetSize,v.polyOrder); % polynomial regression filter
        Fm = polyregMatrix(v.packetSize,v.polyOrder); % polynomial regression filter
        iq=reshape(iq,packet,ranges*beams);%reshape to prepare for matrix muliplication
        iqhp=Fm*iq;
        iqhp=reshape(iqhp,packet,ranges,beams);%reshape back to orig. size
        %iqhp = iqhp(2:end-1,:,:); %Avoid edge effects from filter
        vThresh = getpolyRegCutoff(v)/100; %[m/s]
        
        %vThresh = 0.42*((v.polyOrder+1)*v.c*v.PRF)/(2*packet*v.f_demod); %Approximate -3dB cutoffvalue (phd S. Bj?rum E-4)
    case 'hbfi'
        b = [-0.4909,0.6436,0.0773,-0.1226,-0.1077]; %regular bfi filter
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        vThresh = v.c*658.7/(2*v.f_demod); % -3dB cutoff [m/s]
        
    case 'hSTLow1'
        b =[-0.0860,-0.1868,-0.6281,0.6281,0.1868, 0.0860]; % Very low cut-off, zero-point at DC
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        vThresh = 0.04728; % -3dB cutoff [m/s]
        
    case 'hSTLow2'
        b = [-0.0995   -0.1080   -0.1144   -0.1184  0.8803   -0.1184   -0.1144   -0.1080   -0.0995]; % Cut-off 0.2 norm.,70dB damping
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        vThresh = 0.0539; % -3dB cutoff [m/s]
        
    case 'FIR92'

   b = [ 0.0118   -0.0029   -0.0028   -0.0028   -0.0028   -0.0029   -0.0030   -0.0030   -0.0029   -0.0027   -0.0024   -0.0019   -0.0013   -0.0005    0.0004    0.0015    0.0027    0.0039    0.0051...
         0.0063    0.0073    0.0082    0.0088    0.0092    0.0091    0.0086    0.0076    0.0061    0.0041    0.0016   -0.0015   -0.0051   -0.0091   -0.0135   -0.0182   -0.0231   -0.0281   -0.0331...
        -0.0380   -0.0427   -0.0470   -0.0509   -0.0542   -0.0568   -0.0588   -0.0600    0.9396   -0.0600   -0.0588   -0.0568   -0.0542   -0.0509   -0.0470   -0.0427   -0.0380   -0.0331   -0.0281...
        -0.0231   -0.0182   -0.0135   -0.0091   -0.0051   -0.0015    0.0016    0.0041    0.0061    0.0076    0.0086    0.0091    0.0092    0.0088    0.0082    0.0073    0.0063    0.0051    0.0039...
         0.0027    0.0015    0.0004   -0.0005   -0.0013   -0.0019   -0.0024   -0.0027   -0.0029   -0.0030   -0.0030   -0.0029   -0.0028   -0.0028   -0.0028   -0.0029    0.0118];
        
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        vThresh =  0.068*v.vNyq; % -3dB cutoff [m/s]
     
        
    case 'FIR92_2'
        
    b = [0.0054   -0.0056   -0.0038   -0.0028   -0.0022   -0.0018   -0.0015   -0.0012   -0.0008   -0.0003    0.0003    0.0010    0.0017    0.0025    0.0034    0.0042    0.0050    0.0058    0.0064...
         0.0069    0.0072    0.0073    0.0071    0.0066    0.0058    0.0046    0.0030    0.0010   -0.0013   -0.0040   -0.0070   -0.0103   -0.0139   -0.0176   -0.0215   -0.0255   -0.0295   -0.0334...
        -0.0371   -0.0407   -0.0439   -0.0467   -0.0492   -0.0511   -0.0525   -0.0534    0.9463   -0.0534   -0.0525   -0.0511   -0.0492   -0.0467   -0.0439   -0.0407   -0.0371   -0.0334   -0.0295...
        -0.0255   -0.0215   -0.0176   -0.0139   -0.0103   -0.0070   -0.0040   -0.0013    0.0010    0.0030    0.0046    0.0058    0.0066    0.0071    0.0073    0.0072    0.0069    0.0064    0.0058...
         0.0050    0.0042    0.0034    0.0025    0.0017    0.0010    0.0003   -0.0003   -0.0008   -0.0012   -0.0015   -0.0018   -0.0022   -0.0028   -0.0038   -0.0056    0.0054];

        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        vThresh =  0.0613*v.vNyq; % -3dB cutoff [m/s]
        
        
    case 'FIR70'

   b = [ 0.0050   -0.0059   -0.0040   -0.0031   -0.0025   -0.0020   -0.0014   -0.0006    0.0004    0.0016    0.0030    0.0045    0.0060    0.0074    0.0086    0.0094    0.0098    0.0095    0.0085...
         0.0067    0.0040    0.0004   -0.0041   -0.0093   -0.0153   -0.0218   -0.0287   -0.0358   -0.0428   -0.0495   -0.0557   -0.0611   -0.0655   -0.0688   -0.0709    0.9285   -0.0709   -0.0688...
        -0.0655   -0.0611   -0.0557   -0.0495   -0.0428   -0.0358   -0.0287   -0.0218   -0.0153   -0.0093   -0.0041    0.0004    0.0040    0.0067    0.0085    0.0095    0.0098    0.0094    0.0086...
         0.0074    0.0060    0.0045    0.0030    0.0016    0.0004   -0.0006   -0.0014   -0.0020   -0.0025   -0.0031   -0.0040   -0.0059    0.0050];
        
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        vThresh =  0.0817*v.vNyq; % -3dB cutoff [m/s] (wstop = 0.02*vNyq,wpass = 0.1*vNyq)
        
    case 'FIR74'
        
    b = [0.0112   -0.0033   -0.0032   -0.0033   -0.0035   -0.0036   -0.0037   -0.0035   -0.0031   -0.0024   -0.0014   -0.0000    0.0016    0.0034    0.0053    0.0072    0.0089    0.0103    0.0112    0.0115    0.0109    0.0095    0.0070    0.0036...
        -0.0009   -0.0064   -0.0128   -0.0198   -0.0274   -0.0352   -0.0430   -0.0505   -0.0575   -0.0636   -0.0686   -0.0723   -0.0747    0.9246   -0.0747   -0.0723   -0.0686   -0.0636   -0.0575   -0.0505   -0.0430   -0.0352   -0.0274   -0.0198...
        -0.0128   -0.0064   -0.0009    0.0036    0.0070    0.0095    0.0109    0.0115    0.0112    0.0103    0.0089    0.0072    0.0053    0.0034    0.0016   -0.0000   -0.0014   -0.0024   -0.0031   -0.0035   -0.0037   -0.0036   -0.0035   -0.0033...
        -0.0032   -0.0033    0.0112];
    
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        
        vThresh = 0.0851*v.vNyq; %(Broader stopband than FIR70, wstop = 0.025*vNyq,wpass = 0.1*vNyq)
        
        
        case 'FIR30'
     
    b = [-0.0118   -0.0031   -0.0000    0.0054    0.0121    0.0181    0.0209    0.0179    0.0071   -0.0119   -0.0382   -0.0690   -0.1001   -0.1269   -0.1450    0.8486   -0.1450   -0.1269   -0.1001   -0.0690   -0.0382   -0.0119    0.0071    0.0179...    
         0.0209    0.0181    0.0121    0.0054   -0.0000   -0.0031   -0.0118];
     
       
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        
        vThresh = 0.1726*v.vNyq; %( wstop = 0.05*vNyq,wpass = 0.21*vNyq)
        
        
    case 'FIR30_2'
    
    b = [-0.0054    0.0083    0.0091    0.0109    0.0117    0.0101    0.0051   -0.0040   -0.0171   -0.0338   -0.0528   -0.0723   -0.0905   -0.1052   -0.1149    0.8818   -0.1149   -0.1052   -0.0905   -0.0723   -0.0528   -0.0338   -0.0171   -0.0040...
        0.0051    0.0101    0.0117    0.0109    0.0091    0.0083   -0.0054];
          
        iqhp = filter(b,1,iq,[],1);
        iqhp = iqhp(length(b):end,:,:);
        
        vThresh = 0.14*v.vNyq; %( wstop = 0.02*vNyq,wpass = 0.18*vNyq)
     
        
     
    case 'no'
        iqhp = iq;
        vThresh = 0;
        
    otherwise
        disp('Unknown filter method')
        
end


end