
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Focused Linear scan with L7-4 probe in Verasonics demonstrating RTB</title><meta name="generator" content="MATLAB 9.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-05-11"><meta name="DC.source" content="FI_UFF_Verasonics_linear_RTB_fix.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Focused Linear scan with L7-4 probe in Verasonics demonstrating RTB</h1><!--introduction--><p>This script is available in the USTB repository as examples/uff/FI_UFF_Verasonics_linear_RTB.m</p><p>This example demonstrates the RTB implementation and demonstrates different fixes to the artifact occuring near the focus.</p><p>One solution is the transmit delay model introduced in  Nguyen, N. Q., &amp; Prager, R. W. (2016). High-Resolution Ultrasound Imaging With Unified Pixel-Based Beamforming. IEEE Trans. Med. Imaging, 35(1), 98-108.</p><p>Another solution is a simpler model assuming PW around focus.</p><p>This scripts creates the figure used in the abstract submitted to the IEEE IUS 2018 with title "A simple, artifact-free virtual source model"</p><p>_by Ole Marius Hoel Rindal <a href="olemarius@olemarius.net">olemarius@olemarius.net</a> Last updated: 2018/10/05</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Read channel data</a></li><li><a href="#2">Define Scan</a></li><li><a href="#3">Conventional Scanline Beamforming</a></li><li><a href="#5">Retrospective beamforming (RTB) with conventional virtual source model</a></li><li><a href="#8">RTB using Nguyen &amp; Prager model</a></li><li><a href="#10">RTB using a simpler model assuming PW around focus</a></li><li><a href="#12">Create plot to be used in abstract showing the images and the TX delays</a></li></ul></div><h2 id="1">Read channel data</h2><pre class="codeinput">clear <span class="string">all</span>; close <span class="string">all</span>;

<span class="comment">% data location</span>
url=<span class="string">'http://ustb.no/datasets/'</span>;      <span class="comment">% if not found downloaded from here</span>

filename=<span class="string">'L7_FI_IUS2018.uff'</span>;
tools.download(filename, url, data_path);
channel_data=uff.read_object([data_path filesep filename],<span class="string">'/channel_data'</span>);
</pre><pre class="codeoutput">UFF: reading channel_data [uff.channel_data]
UFF: reading sequence [uff.wave] [====================] 100%
</pre><h2 id="2">Define Scan</h2><pre class="codeinput">x_axis=zeros(channel_data.N_waves,1);
<span class="keyword">for</span> n=1:channel_data.N_waves
    x_axis(n)=channel_data.sequence(n).source.x;
<span class="keyword">end</span>
z_axis=linspace(1e-3,62e-3,512*2).';
scan=uff.linear_scan(<span class="string">'x_axis'</span>,x_axis,<span class="string">'z_axis'</span>,z_axis);
</pre><h2 id="3">Conventional Scanline Beamforming</h2><pre class="codeinput">mid=midprocess.das();
mid.dimension = dimension.both();

mid.channel_data=channel_data;
mid.scan=scan;

mid.transmit_apodization.window=uff.window.scanline;

mid.receive_apodization.window=uff.window.none;
mid.receive_apodization.f_number=1.7;

b_data=mid.go();
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Display image</p><pre class="codeinput">b_data.plot([],<span class="string">'Conventional one scanline per transmit'</span>);
</pre><img vspace="5" hspace="5" src="FI_UFF_Verasonics_linear_RTB_fix_01.png" alt=""> <h2 id="5">Retrospective beamforming (RTB) with conventional virtual source model</h2><p>Create scan with MLA's</p><pre class="codeinput">MLA = 4;
scan_RTB=uff.linear_scan(<span class="string">'x_axis'</span>,linspace(x_axis(1),x_axis(end),<span class="keyword">...</span>
                                    length(x_axis)*MLA)',<span class="string">'z_axis'</span>,z_axis);

<span class="comment">% beamform without any fix using conventional virtual source model</span>
mid_RTB=midprocess.das();
mid_RTB.dimension = dimension.both();

mid_RTB.channel_data=channel_data;
mid_RTB.scan=scan_RTB;

mid_RTB.transmit_apodization.window=uff.window.tukey50;
mid_RTB.transmit_apodization.f_number = 3;
mid_RTB.transmit_apodization.MLA = MLA;
mid_RTB.transmit_apodization.MLA_overlap = MLA;

mid_RTB.receive_apodization.window=uff.window.boxcar;
mid_RTB.receive_apodization.f_number=1.7;
b_data_RTB=mid_RTB.go();

b_data_RTB.plot(767,<span class="string">'RTB image using virtual source model'</span>);
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><img vspace="5" hspace="5" src="FI_UFF_Verasonics_linear_RTB_fix_02.png" alt=""> <p>We need to compensate with the TX transmit apodization as weighting to get a more uniform image</p><pre class="codeinput"><span class="comment">% Calculate the transmit apodzation used to compensate image</span>
tx_apod = mid_RTB.transmit_apodization.data;

b_data_RTB_weighted = uff.beamformed_data(b_data_RTB);
b_data_RTB_weighted.data = b_data_RTB_weighted.data.*(1./sum(tx_apod,2));
b_data_RTB_weighted.plot(10,<span class="string">'RTB image using virtual source model, TX weighted'</span>);
</pre><pre class="codeoutput">uff.apodization: Inputs and outputs are unchanged. Skipping process.
</pre><img vspace="5" hspace="5" src="FI_UFF_Verasonics_linear_RTB_fix_03.png" alt=""> <p>Notice the darker right side. Not sure why this occurs, it is not there for conventional scanline beamforming, and not for MLA's. Could it be that the elemets to the right of the probe are weaker? I'll investigate this further...</p><p>Also notice the line/articat along 29.6 mm, the transmit focus, which is the artifact we aimt get rid of :)</p><h2 id="8">RTB using Nguyen &amp; Prager model</h2><p>beamforming using the "unified pixelbased beamforming" model from Nguyen, N. Q., &amp; Prager, R. W. (2016). High-Resolution Ultrasound Imaging With Unified Pixel-Based Beamforming. IEEE Trans. Med. Imaging, 35(1), 98-108.</p><pre class="codeinput">mid_RTB_unified_fix =midprocess.das();
mid_RTB_unified_fix.dimension = dimension.both();

mid_RTB_unified_fix.channel_data=channel_data;
mid_RTB_unified_fix.scan=scan_RTB;
mid_RTB_unified_fix.use_unified_fix = 1; <span class="comment">%When this flat is set this model is used</span>

mid_RTB_unified_fix.transmit_apodization.window=uff.window.tukey50;
mid_RTB_unified_fix.transmit_apodization.f_number = 3;
mid_RTB_unified_fix.transmit_apodization.MLA = MLA;
mid_RTB_unified_fix.transmit_apodization.MLA_overlap = 1;

mid_RTB_unified_fix.receive_apodization.window=uff.window.boxcar;
mid_RTB_unified_fix.receive_apodization.f_number=1.7;
b_data_RTB_unified_fix=mid_RTB_unified_fix.go();

<span class="comment">% Calculate the transmit apodzation used to compensate image</span>
tx_apod = mid_RTB_unified_fix.transmit_apodization.data;

b_data_RTB_unified_fix_weighted = uff.beamformed_data(b_data_RTB_unified_fix);
b_data_RTB_unified_fix_weighted.data = b_data_RTB_unified_fix_weighted.data<span class="keyword">...</span>
                                                        .*(1./sum(tx_apod,2));
b_data_RTB_unified_fix_weighted.plot(11,<span class="string">'RTB image Nguyen &amp; Prager mode'</span>);
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
uff.apodization: Inputs and outputs are unchanged. Skipping process.
</pre><img vspace="5" hspace="5" src="FI_UFF_Verasonics_linear_RTB_fix_04.png" alt=""> <p>Their model sucessfully removes the artifact at focus (29.6 mm)!</p><h2 id="10">RTB using a simpler model assuming PW around focus</h2><pre class="codeinput">mid_RTB_with_plane_fix=midprocess.das();
mid_RTB_with_plane_fix.dimension = dimension.both();
mid_RTB_with_plane_fix.use_PW_fix = 1; <span class="comment">% Set this flag to use this model</span>
<span class="comment">%Optionally set the margin of the region around focus to use PW tx delay</span>
mid_RTB_with_plane_fix.margin_in_m = 1/1000;

mid_RTB_with_plane_fix.channel_data=channel_data;
mid_RTB_with_plane_fix.scan=scan_RTB;

mid_RTB_with_plane_fix.transmit_apodization.window=uff.window.tukey50;
mid_RTB_with_plane_fix.transmit_apodization.f_number = 3;
mid_RTB_with_plane_fix.transmit_apodization.MLA = MLA;
mid_RTB_with_plane_fix.transmit_apodization.MLA_overlap = 1;

mid_RTB_with_plane_fix.receive_apodization.window=uff.window.boxcar;
mid_RTB_with_plane_fix.receive_apodization.f_number=1.7;
b_data_RTB_with_plane_fix=mid_RTB_with_plane_fix.go();

<span class="comment">% Calculate the transmit apodzation used to compensate image</span>
tx_apod = mid_RTB_with_plane_fix.transmit_apodization.data;

b_data_RTB_plane_fix_weighted = uff.beamformed_data(b_data_RTB_with_plane_fix);
b_data_RTB_plane_fix_weighted.data = b_data_RTB_plane_fix_weighted.data<span class="keyword">...</span>
                                                        .*(1./sum(tx_apod,2));
b_data_RTB_plane_fix_weighted.plot(10,<span class="string">'RTB image with PW hybrid virtual source model'</span>);
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
uff.apodization: Inputs and outputs are unchanged. Skipping process.
</pre><img vspace="5" hspace="5" src="FI_UFF_Verasonics_linear_RTB_fix_05.png" alt=""> <p>Our simplified model also removes the artifact</p><h2 id="12">Create plot to be used in abstract showing the images and the TX delays</h2><p>The images can be zoomed in on the artifact as we did in the abstract, and we can see that both the Nguyen &amp; Prager model, and our simple PW model sucessfully removes the artifact at focus.</p><pre class="codeinput"><span class="comment">% We are plotting the TX delay used for the center transmit beam</span>
tx_delay_virtual_source = reshape(mid_RTB.tx_delay_hack,scan_RTB.N_z_axis,<span class="keyword">...</span>
                                    scan_RTB.N_x_axis,channel_data.N_waves);
tx_delay_unified_fix = reshape(mid_RTB_unified_fix.tx_delay_hack,scan_RTB.N_z_axis,<span class="keyword">...</span>
                                    scan_RTB.N_x_axis,channel_data.N_waves);
tx_delay_plane_fix = reshape(mid_RTB_with_plane_fix.tx_delay_hack,scan_RTB.N_z_axis,<span class="keyword">...</span>
                                    scan_RTB.N_x_axis,channel_data.N_waves);

h = figure(100);clf;
b_data_RTB_weighted.plot(subplot(2,3,1),<span class="string">'1a : Virtual source model'</span>);
ax(1) = gca;
b_data_RTB_unified_fix_weighted.plot(subplot(2,3,2),<span class="string">'1b : Model from [1]'</span>);
ax(2) = gca;
b_data_RTB_plane_fix_weighted.plot(subplot(2,3,3),<span class="string">'1c : Virt. source+PW model'</span>);
ax(3) = gca;
linkaxes(ax);
axis([5 12 26 36])

subplot(2,3,4); imagesc(scan_RTB.x_axis*1000, scan_RTB.z_axis*1000, <span class="keyword">...</span>
                    tx_delay_virtual_source(:,:,channel_data.N_waves/2));
title(<span class="string">'1d: Tx delay virtual source model'</span>);xlabel(<span class="string">'x [mm]'</span>);ylabel(<span class="string">'z [mm]'</span>);
colorbar; set(gca,<span class="string">'fontsize'</span>,14);
subplot(2,3,5); imagesc(scan_RTB.x_axis*1000, scan_RTB.z_axis*1000, <span class="keyword">...</span>
                            tx_delay_unified_fix(:,:,channel_data.N_waves/2));
title(<span class="string">'1e: Tx delay model from [1]'</span>);xlabel(<span class="string">'x [mm]'</span>);ylabel(<span class="string">'z [mm]'</span>);
colorbar; set(gca,<span class="string">'fontsize'</span>,14);
subplot(2,3,6); imagesc(scan_RTB.x_axis*1000, scan_RTB.z_axis*1000, <span class="keyword">...</span><span class="comment">.</span>
                            tx_delay_plane_fix(:,:,channel_data.N_waves/2));
title(<span class="string">'1f: Tx delay virt. source+PW model'</span>);xlabel(<span class="string">'x [mm]'</span>);ylabel(<span class="string">'z [mm]'</span>);
colorbar; set(gca,<span class="string">'fontsize'</span>,14);<span class="comment">%colormap jet;</span>

set(h,<span class="string">'Position'</span>,[271    38   843   621]);

<span class="comment">% A few trics to get the colormap in the submitted abstract:</span>
<span class="comment">% 1. Run the three bottom subplots with colormap jet</span>
<span class="comment">% 2. Rerun the three first subplots to get colormap gray</span>
</pre><img vspace="5" hspace="5" src="FI_UFF_Verasonics_linear_RTB_fix_06.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Focused Linear scan with L7-4 probe in Verasonics demonstrating RTB
%
% This script is available in the USTB repository as
% examples/uff/FI_UFF_Verasonics_linear_RTB.m
%
% This example demonstrates the RTB implementation and demonstrates
% different fixes to the artifact occuring near the focus.
%
% One solution is the transmit delay model introduced in  Nguyen, N. Q., &
% Prager, R. W. (2016). High-Resolution Ultrasound Imaging With Unified Pixel-Based 
% Beamforming. IEEE Trans. Med. Imaging, 35(1), 98-108.
%
% Another solution is a simpler model assuming PW around focus.
%
% This scripts creates the figure used in the abstract submitted to
% the IEEE IUS 2018 with title "A simple, artifact-free virtual source model"
%   
% _by Ole Marius Hoel Rindal <olemarius@olemarius.net> Last updated: 2018/10/05

%% Read channel data

clear all; close all;

% data location
url='http://ustb.no/datasets/';      % if not found downloaded from here

filename='L7_FI_IUS2018.uff';
tools.download(filename, url, data_path);   
channel_data=uff.read_object([data_path filesep filename],'/channel_data');

%% Define Scan
x_axis=zeros(channel_data.N_waves,1);
for n=1:channel_data.N_waves
    x_axis(n)=channel_data.sequence(n).source.x;
end
z_axis=linspace(1e-3,62e-3,512*2).';
scan=uff.linear_scan('x_axis',x_axis,'z_axis',z_axis);

%% Conventional Scanline Beamforming
mid=midprocess.das();
mid.dimension = dimension.both();

mid.channel_data=channel_data;
mid.scan=scan;

mid.transmit_apodization.window=uff.window.scanline;

mid.receive_apodization.window=uff.window.none;
mid.receive_apodization.f_number=1.7;

b_data=mid.go();

%%
% Display image
b_data.plot([],'Conventional one scanline per transmit');


%% Retrospective beamforming (RTB) with conventional virtual source model
% Create scan with MLA's
MLA = 4;
scan_RTB=uff.linear_scan('x_axis',linspace(x_axis(1),x_axis(end),...
                                    length(x_axis)*MLA)','z_axis',z_axis);

% beamform without any fix using conventional virtual source model
mid_RTB=midprocess.das();
mid_RTB.dimension = dimension.both();

mid_RTB.channel_data=channel_data;
mid_RTB.scan=scan_RTB;

mid_RTB.transmit_apodization.window=uff.window.tukey50;
mid_RTB.transmit_apodization.f_number = 3;
mid_RTB.transmit_apodization.MLA = MLA;
mid_RTB.transmit_apodization.MLA_overlap = MLA;

mid_RTB.receive_apodization.window=uff.window.boxcar;
mid_RTB.receive_apodization.f_number=1.7;
b_data_RTB=mid_RTB.go();

b_data_RTB.plot(767,'RTB image using virtual source model');
%%
% We need to compensate with the TX transmit apodization as weighting to
% get a more uniform image

% Calculate the transmit apodzation used to compensate image
tx_apod = mid_RTB.transmit_apodization.data;

b_data_RTB_weighted = uff.beamformed_data(b_data_RTB);
b_data_RTB_weighted.data = b_data_RTB_weighted.data.*(1./sum(tx_apod,2));
b_data_RTB_weighted.plot(10,'RTB image using virtual source model, TX weighted');

%%
% Notice the darker right side. Not sure why this occurs, it is not there
% for conventional scanline beamforming, and not for MLA's. Could it be
% that the elemets to the right of the probe are weaker? I'll investigate
% this further...
%
% Also notice the line/articat along 29.6 mm, the transmit focus, which is 
% the artifact we aimt get rid of :)

%% RTB using Nguyen & Prager model
% beamforming using the "unified pixelbased beamforming" model from 
% Nguyen, N. Q., & Prager, R. W. (2016). High-Resolution Ultrasound Imaging 
% With Unified Pixel-Based Beamforming. IEEE Trans. Med. Imaging, 35(1), 98-108.
mid_RTB_unified_fix =midprocess.das();
mid_RTB_unified_fix.dimension = dimension.both();

mid_RTB_unified_fix.channel_data=channel_data;
mid_RTB_unified_fix.scan=scan_RTB;
mid_RTB_unified_fix.use_unified_fix = 1; %When this flat is set this model is used

mid_RTB_unified_fix.transmit_apodization.window=uff.window.tukey50;
mid_RTB_unified_fix.transmit_apodization.f_number = 3;
mid_RTB_unified_fix.transmit_apodization.MLA = MLA;
mid_RTB_unified_fix.transmit_apodization.MLA_overlap = 1;

mid_RTB_unified_fix.receive_apodization.window=uff.window.boxcar;
mid_RTB_unified_fix.receive_apodization.f_number=1.7;
b_data_RTB_unified_fix=mid_RTB_unified_fix.go();

% Calculate the transmit apodzation used to compensate image
tx_apod = mid_RTB_unified_fix.transmit_apodization.data;

b_data_RTB_unified_fix_weighted = uff.beamformed_data(b_data_RTB_unified_fix);
b_data_RTB_unified_fix_weighted.data = b_data_RTB_unified_fix_weighted.data...
                                                        .*(1./sum(tx_apod,2));
b_data_RTB_unified_fix_weighted.plot(11,'RTB image Nguyen & Prager mode');

%%
% Their model sucessfully removes the artifact at focus (29.6 mm)!

%% RTB using a simpler model assuming PW around focus
mid_RTB_with_plane_fix=midprocess.das();
mid_RTB_with_plane_fix.dimension = dimension.both();
mid_RTB_with_plane_fix.use_PW_fix = 1; % Set this flag to use this model
%Optionally set the margin of the region around focus to use PW tx delay
mid_RTB_with_plane_fix.margin_in_m = 1/1000; 

mid_RTB_with_plane_fix.channel_data=channel_data;
mid_RTB_with_plane_fix.scan=scan_RTB;

mid_RTB_with_plane_fix.transmit_apodization.window=uff.window.tukey50;
mid_RTB_with_plane_fix.transmit_apodization.f_number = 3;
mid_RTB_with_plane_fix.transmit_apodization.MLA = MLA;
mid_RTB_with_plane_fix.transmit_apodization.MLA_overlap = 1;

mid_RTB_with_plane_fix.receive_apodization.window=uff.window.boxcar;
mid_RTB_with_plane_fix.receive_apodization.f_number=1.7;
b_data_RTB_with_plane_fix=mid_RTB_with_plane_fix.go();

% Calculate the transmit apodzation used to compensate image
tx_apod = mid_RTB_with_plane_fix.transmit_apodization.data;

b_data_RTB_plane_fix_weighted = uff.beamformed_data(b_data_RTB_with_plane_fix);
b_data_RTB_plane_fix_weighted.data = b_data_RTB_plane_fix_weighted.data...
                                                        .*(1./sum(tx_apod,2));
b_data_RTB_plane_fix_weighted.plot(10,'RTB image with PW hybrid virtual source model');

%%
% Our simplified model also removes the artifact

%% Create plot to be used in abstract showing the images and the TX delays
% The images can be zoomed in on the artifact as we did in the abstract,
% and we can see that both the Nguyen & Prager model, and our simple PW
% model sucessfully removes the artifact at focus.

% We are plotting the TX delay used for the center transmit beam
tx_delay_virtual_source = reshape(mid_RTB.tx_delay_hack,scan_RTB.N_z_axis,...
                                    scan_RTB.N_x_axis,channel_data.N_waves);
tx_delay_unified_fix = reshape(mid_RTB_unified_fix.tx_delay_hack,scan_RTB.N_z_axis,...
                                    scan_RTB.N_x_axis,channel_data.N_waves);
tx_delay_plane_fix = reshape(mid_RTB_with_plane_fix.tx_delay_hack,scan_RTB.N_z_axis,...
                                    scan_RTB.N_x_axis,channel_data.N_waves);

h = figure(100);clf;
b_data_RTB_weighted.plot(subplot(2,3,1),'1a : Virtual source model');
ax(1) = gca;
b_data_RTB_unified_fix_weighted.plot(subplot(2,3,2),'1b : Model from [1]');
ax(2) = gca;
b_data_RTB_plane_fix_weighted.plot(subplot(2,3,3),'1c : Virt. source+PW model');
ax(3) = gca;
linkaxes(ax);
axis([5 12 26 36])

subplot(2,3,4); imagesc(scan_RTB.x_axis*1000, scan_RTB.z_axis*1000, ...
                    tx_delay_virtual_source(:,:,channel_data.N_waves/2));
title('1d: Tx delay virtual source model');xlabel('x [mm]');ylabel('z [mm]');
colorbar; set(gca,'fontsize',14); 
subplot(2,3,5); imagesc(scan_RTB.x_axis*1000, scan_RTB.z_axis*1000, ...
                            tx_delay_unified_fix(:,:,channel_data.N_waves/2)); 
title('1e: Tx delay model from [1]');xlabel('x [mm]');ylabel('z [mm]');
colorbar; set(gca,'fontsize',14);
subplot(2,3,6); imagesc(scan_RTB.x_axis*1000, scan_RTB.z_axis*1000, ....
                            tx_delay_plane_fix(:,:,channel_data.N_waves/2));
title('1f: Tx delay virt. source+PW model');xlabel('x [mm]');ylabel('z [mm]');
colorbar; set(gca,'fontsize',14);%colormap jet;

set(h,'Position',[271    38   843   621]);

% A few trics to get the colormap in the submitted abstract:
% 1. Run the three bottom subplots with colormap jet
% 2. Rerun the three first subplots to get colormap gray

##### SOURCE END #####
--></body></html>