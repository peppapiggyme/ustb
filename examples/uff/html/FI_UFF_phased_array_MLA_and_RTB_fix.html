
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>FI_UFF_phased_array_MLA_and_RTB_fix</title><meta name="generator" content="MATLAB 9.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-05-14"><meta name="DC.source" content="FI_UFF_phased_array_MLA_and_RTB_fix.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Multiple line aqusition (MLA) and retrospective beamformgin (RTB) for a phased array sector scan</a></li><li><a href="#2">Create the sector scan we want to reconstruct</a></li><li><a href="#3">Conventional Scanline Beamforming</a></li><li><a href="#5">Define scan with 8 MLA's</a></li><li><a href="#6">MLA beamforming with conventional virtual source model</a></li><li><a href="#9">MLA beamforming with Nguyen &amp; Prager model</a></li><li><a href="#12">MLA beamforming using our simple model assuming PW around focus</a></li><li><a href="#15">Lets have a closer look at the focal region</a></li><li><a href="#17">RTB using convetional virtual source model</a></li><li><a href="#19">Get the transmit apod to give the image correct weighting</a></li><li><a href="#22">RTB with Nguyen &amp; Prager model</a></li><li><a href="#25">RTB with hybrid PW model</a></li></ul></div><h2 id="1">Multiple line aqusition (MLA) and retrospective beamformgin (RTB) for a phased array sector scan</h2><p>This script is available in the USTB repository as examples/uff/FI_UFF_phased_array_MLA_and_RTB_fix.m</p><p>This example demonstrates the MLA and RTB implementation and demonstrates different fixes to the artifact occuring near the focus for a sector scan.</p><p>One solution is the transmit delay model introduced in  Nguyen, N. Q., &amp; Prager, R. W. (2016). High-Resolution Ultrasound Imaging With Unified Pixel-Based Beamforming. IEEE Trans. Med. Imaging, 35(1), 98-108.</p><p>Another solution is a simpler model assuming PW around focus.</p><p>_by Ole Marius Hoel Rindal <a href="olemarius@olemarius.net">olemarius@olemarius.net</a> Last updated: 2018/10/05</p><pre class="codeinput"><span class="comment">% Clear up</span>
clear <span class="string">all</span>; close <span class="string">all</span>;

<span class="comment">% Read the data, poentitally download it</span>
url=<span class="string">'http://ustb.no/datasets/'</span>;      <span class="comment">% if not found downloaded from here</span>
local_path = [ustb_path(),<span class="string">'/data/'</span>]; <span class="comment">% location of example data</span>
addpath(local_path);

<span class="comment">% Choose dataset</span>
filename=<span class="string">'P4_FI.uff'</span>;

<span class="comment">% check if the file is available in the local path or downloads otherwise</span>
tools.download(filename, url, local_path);
channel_data = uff.read_object([local_path, filename],<span class="string">'/channel_data'</span>);
</pre><pre class="codeoutput">UFF: reading channel_data [uff.channel_data]
UFF: reading sequence [uff.wave] [====================] 100%
</pre><h2 id="2">Create the sector scan we want to reconstruct</h2><pre class="codeinput">scan=uff.sector_scan(<span class="string">'azimuth_axis'</span>,<span class="keyword">...</span>
    linspace(channel_data.sequence(1).source.azimuth,<span class="keyword">...</span>
                channel_data.sequence(end).source.azimuth,<span class="keyword">...</span>
                length(channel_data.sequence))',<span class="keyword">...</span>
    <span class="string">'depth_axis'</span>,linspace(0,90e-3,512)');
</pre><h2 id="3">Conventional Scanline Beamforming</h2><pre class="codeinput">mid = midprocess.das();
mid.channel_data=channel_data;
mid.dimension = dimension.both();
mid.scan=scan;
mid.transmit_apodization.window=uff.window.scanline;
mid.receive_apodization.window=uff.window.tukey25;
mid.receive_apodization.f_number = 1.7;

b_data = mid.go();
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Display image</p><pre class="codeinput">b_data.plot(40,[<span class="string">'Conventional one scanline per transmit'</span>]);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_01.png" alt=""> <h2 id="5">Define scan with 8 MLA's</h2><pre class="codeinput">MLA = 8;
scan_MLA=uff.sector_scan(<span class="string">'azimuth_axis'</span>,<span class="keyword">...</span>
    linspace(scan.azimuth_axis(1),scan.azimuth_axis(end),<span class="keyword">...</span>
    scan.N_azimuth_axis*MLA)'<span class="keyword">...</span>
    ,<span class="string">'depth_axis'</span>,scan.depth_axis);
</pre><h2 id="6">MLA beamforming with conventional virtual source model</h2><pre class="codeinput">mid_MLA=midprocess.das();
mid_MLA.channel_data=channel_data;
mid_MLA.dimension = dimension.both();
mid_MLA.scan=scan_MLA;
mid_MLA.transmit_apodization.window=uff.window.scanline;
mid_MLA.transmit_apodization.MLA = MLA;
mid_MLA.transmit_apodization.MLA_overlap = MLA;
mid_MLA.receive_apodization.window=uff.window.tukey25;
mid_MLA.receive_apodization.f_number = 1.7;

b_data_MLA = mid_MLA.go();
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Plot the image</p><pre class="codeinput">b_data_MLA.plot(41,[<span class="string">'MLA image conventional virtual source model'</span>]);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_02.png" alt=""> <p>Notice the artifact seen at radial distance about 50 mm from the origin, yes the artifact can be somewhat hard to see. It will be easier to see in the images that are zoomed in.</p><h2 id="9">MLA beamforming with Nguyen &amp; Prager model</h2><pre class="codeinput">mid_MLA_unified_fix=midprocess.das();
mid_MLA_unified_fix.channel_data=channel_data;
mid_MLA_unified_fix.dimension = dimension.both();
<span class="comment">%By setting this we use the Prager &amp; Nguyen model</span>
mid_MLA_unified_fix.use_unified_fix = 1;
mid_MLA_unified_fix.scan=scan_MLA;
mid_MLA_unified_fix.transmit_apodization.window=uff.window.scanline;
mid_MLA_unified_fix.transmit_apodization.MLA = MLA;
mid_MLA_unified_fix.transmit_apodization.MLA_overlap = MLA;
mid_MLA_unified_fix.receive_apodization.window=uff.window.tukey25;
mid_MLA_unified_fix.receive_apodization.f_number = 1.7;

b_data_MLA_unified_fix = mid_MLA_unified_fix.go();
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Plot the image</p><pre class="codeinput">b_data_MLA_unified_fix.plot(42,[<span class="string">'MLA image Nguyen &amp; Prager model'</span>]);
ax(4) = gca;
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_03.png" alt=""> <p>Notice that the artifact is gone</p><h2 id="12">MLA beamforming using our simple model assuming PW around focus</h2><pre class="codeinput">mid_MLA_plane_fix=midprocess.das();
mid_MLA_plane_fix.channel_data=channel_data;
mid_MLA_plane_fix.dimension = dimension.both();
<span class="comment">%By setting this we use the simple PW model</span>
mid_MLA_plane_fix.use_PW_fix = 1;
mid_MLA_plane_fix.margin_in_m = 4/1000;
mid_MLA_plane_fix.scan=scan_MLA;
mid_MLA_plane_fix.transmit_apodization.window=uff.window.scanline;
mid_MLA_plane_fix.transmit_apodization.MLA = MLA;
mid_MLA_plane_fix.transmit_apodization.MLA_overlap = MLA;
mid_MLA_plane_fix.receive_apodization.window=uff.window.tukey25;
mid_MLA_plane_fix.receive_apodization.f_number = 1.7;

b_data_MLA_plane_fix = mid_MLA_plane_fix.go();
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Plot the image</p><pre class="codeinput">b_data_MLA_plane_fix.plot(43,[<span class="string">'MLA image with PW hybrid virtual source model'</span>]);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_04.png" alt=""> <p>Notice that the artifact is gone.</p><h2 id="15">Lets have a closer look at the focal region</h2><p>Both regions fix the focal region in front of the tranducer</p><pre class="codeinput">f100 = figure(100);
set(f100,<span class="string">'Position'</span>,[260     6   526   694]);
b_data.plot(subplot(4,2,1),[<span class="string">'No MLAs'</span>]);
ax_sub_top(1) = gca;
b_data_MLA.plot(subplot(4,2,2),[<span class="string">'MLAs virtual source'</span>]);
ax_sub_top(2) = gca;
b_data_MLA_unified_fix.plot(subplot(4,2,3),[<span class="string">'MLAs using Nguyen &amp; Prager'</span>]);
ax_sub_top(3) = gca;
b_data_MLA_plane_fix.plot(subplot(4,2,4),[<span class="string">'MLAs using PW model'</span>]);
ax_sub_top(4) = gca;
linkaxes(ax_sub_top)
ylim([45 60]);xlim([-10 10]);

b_data.plot(subplot(4,2,5),[<span class="string">'No MLAs'</span>]);
ax_sub_bottom(1) = gca;
b_data_MLA.plot(subplot(4,2,6),[<span class="string">'MLAs virtual source'</span>]);
ax_sub_bottom(2) = gca;
b_data_MLA_unified_fix.plot(subplot(4,2,7),[<span class="string">'MLAs using Nguyen &amp; Prager'</span>]);
ax_sub_bottom(3) = gca;
b_data_MLA_plane_fix.plot(subplot(4,2,8),[<span class="string">'MLAs using PW model'</span>]);
ax_sub_bottom(4) = gca;
linkaxes(ax_sub_bottom)
ylim([40 55]);xlim([15 35]);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_05.png" alt=""> <p>We can observe that the artifact is removed for both the Nguyen &amp; Prager model, and our simple PW model both in front front of the probe (around x=0mm), and to the side (x=25mm) which was an earlier issue.</p><h2 id="17">RTB using convetional virtual source model</h2><pre class="codeinput">mid_RTB=midprocess.das();
mid_RTB.channel_data=channel_data;
mid_RTB.dimension = dimension.both();
mid_RTB.scan=scan_MLA;
mid_RTB.transmit_apodization.window = uff.window.sector_scan_rtb;
mid_RTB.transmit_apodization.probe = channel_data.probe;
mid_RTB.receive_apodization.window = uff.window.tukey25;
mid_RTB.receive_apodization.f_number = 1.7;

b_data_RTB = mid_RTB.go();
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Display image withough weighting</p><pre class="codeinput">b_data_RTB.plot([],[<span class="string">'RTB with virtual source model not weighted'</span>]);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_06.png" alt=""> <h2 id="19">Get the transmit apod to give the image correct weighting</h2><pre class="codeinput">tx_apod = mid_RTB.transmit_apodization.data;

x_matrix=reshape(scan_MLA.x,[scan_MLA.N_depth_axis scan_MLA.N_azimuth_axis]);
z_matrix=reshape(scan_MLA.z,[scan_MLA.N_depth_axis scan_MLA.N_azimuth_axis]);

figure(88);
pcolor(x_matrix*1e3,z_matrix*1e3,<span class="keyword">...</span>
       reshape(tx_apod(:,51),scan_MLA.N_depth_axis,scan_MLA.N_azimuth_axis));
xlabel(<span class="string">'x [mm]'</span>);
ylabel(<span class="string">'z [mm]'</span>);
shading(<span class="string">'flat'</span>);
set(gca,<span class="string">'fontsize'</span>,14);
set(gca,<span class="string">'YDir'</span>,<span class="string">'reverse'</span>);
axis(<span class="string">'tight'</span>,<span class="string">'equal'</span>);
title(<span class="string">'TX apod from sequence 51'</span>);
</pre><pre class="codeoutput">uff.apodization: Inputs and outputs are unchanged. Skipping process.
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_07.png" alt=""> <p>For illustrational purposes, we'll include a plot of the transmit apodization</p><pre class="codeinput"><span class="comment">% Calculate weights based on the transmit apod</span>
weighting = 1./sum(tx_apod,2);

b_data_RTB_weighted = uff.beamformed_data(b_data_RTB);
b_data_RTB_weighted.data = b_data_RTB_weighted.data.*weighting;

b_data_RTB_weighted.plot(11,<span class="string">'RTB with virtual source model weighted'</span>);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_08.png" alt=""> <p>Notice that we once again have the artifact around focus</p><h2 id="22">RTB with Nguyen &amp; Prager model</h2><pre class="codeinput">mid_RTB_unified_fix=midprocess.das();
mid_RTB_unified_fix.channel_data=channel_data;
mid_RTB_unified_fix.dimension = dimension.both();
mid_RTB_unified_fix.use_unified_fix = 1;
mid_RTB_unified_fix.scan=scan_MLA;
mid_RTB_unified_fix.transmit_apodization.window = uff.window.sector_scan_rtb;
mid_RTB_unified_fix.transmit_apodization.probe = channel_data.probe;
mid_RTB_unified_fix.receive_apodization.window = uff.window.tukey25;
mid_RTB_unified_fix.receive_apodization.f_number = 1.7;

b_data_RTB_unified_fix = mid_RTB_unified_fix.go();

b_data_RTB_unified_fix_weighted = uff.beamformed_data(b_data_RTB_unified_fix);
b_data_RTB_unified_fix_weighted.data = b_data_RTB_unified_fix_weighted.data.*weighting;
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><p>Plot the weighted image</p><pre class="codeinput">b_data_RTB_unified_fix_weighted.plot(12,<span class="string">'RTB with Nguyen &amp; Prager model'</span>);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_09.png" alt=""> <p>Notice that the artifact around focus is removed</p><h2 id="25">RTB with hybrid PW model</h2><pre class="codeinput">mid_RTB_PW_fix=midprocess.das();
mid_RTB_PW_fix.channel_data=channel_data;
mid_RTB_PW_fix.dimension = dimension.both();
mid_RTB_PW_fix.use_PW_fix = 1;
mid_RTB_PW_fix.margin_in_m = 4/1000;
mid_RTB_PW_fix.scan=scan_MLA;
mid_RTB_PW_fix.transmit_apodization.window = uff.window.sector_scan_rtb;
mid_RTB_PW_fix.transmit_apodization.probe = channel_data.probe;
mid_RTB_PW_fix.receive_apodization.window = uff.window.tukey25;
mid_RTB_PW_fix.receive_apodization.f_number = 1.7;

b_data_RTB_PW_fix = mid_RTB_PW_fix.go();

b_data_RTB_PW_fix_weighted = uff.beamformed_data(b_data_RTB_PW_fix);
b_data_RTB_PW_fix_weighted.data = b_data_RTB_PW_fix_weighted.data.*weighting;

b_data_RTB_PW_fix_weighted.plot(13,<span class="string">'RTB with hybrid PW model'</span>);
</pre><pre class="codeoutput">USTB General beamformer MEX v1.1.2 .............done!
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_10.png" alt=""> <p>Notice that the artifact around focus is removed</p><pre class="codeinput">f200 = figure(200);
set(f200,<span class="string">'Position'</span>,[260     6   526   694]);
b_data.plot(subplot(4,2,1),[<span class="string">'No RTB'</span>]);
ax_sub_top(1) = gca;
b_data_RTB_weighted.plot(subplot(4,2,2),[<span class="string">'RTB virtual source'</span>]);
ax_sub_top(2) = gca;
b_data_RTB_unified_fix_weighted.plot(subplot(4,2,3),[<span class="string">'RTB using Nguyen &amp; Prager'</span>]);
ax_sub_top(3) = gca;
b_data_RTB_PW_fix_weighted.plot(subplot(4,2,4),[<span class="string">'RTB using PW model'</span>]);
ax_sub_top(4) = gca;
linkaxes(ax_sub_top)
ylim([45 60]);xlim([-10 10]);

b_data.plot(subplot(4,2,5),[<span class="string">'No RTB'</span>]);
ax_sub_bottom(1) = gca;
b_data_RTB_weighted.plot(subplot(4,2,6),[<span class="string">'RTB virtual source'</span>]);
ax_sub_bottom(2) = gca;
b_data_RTB_unified_fix_weighted.plot(subplot(4,2,7),[<span class="string">'RTB using Nguyen &amp; Prager'</span>]);
ax_sub_bottom(3) = gca;
b_data_RTB_PW_fix_weighted.plot(subplot(4,2,8),[<span class="string">'RTB using PW model'</span>]);
ax_sub_bottom(4) = gca;
linkaxes(ax_sub_bottom)
ylim([40 55]);xlim([15 35]);
</pre><img vspace="5" hspace="5" src="FI_UFF_phased_array_MLA_and_RTB_fix_11.png" alt=""> <p>We can observe that the artifact is removed also for RTB beamforming, for both the Nguyen &amp; Prager model, and our simple PW model both in front front of the probe (around x=0mm), and to the side (x=25mm) which was an earlier issue.</p><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Multiple line aqusition (MLA) and retrospective beamformgin (RTB) for a phased array sector scan
%
% This script is available in the USTB repository as
% examples/uff/FI_UFF_phased_array_MLA_and_RTB_fix.m
%
% This example demonstrates the MLA and RTB implementation and demonstrates
% different fixes to the artifact occuring near the focus for a sector scan.
%
% One solution is the transmit delay model introduced in  Nguyen, N. Q., &
% Prager, R. W. (2016). High-Resolution Ultrasound Imaging With Unified Pixel-Based 
% Beamforming. IEEE Trans. Med. Imaging, 35(1), 98-108.
%
% Another solution is a simpler model assuming PW around focus.
%   
% _by Ole Marius Hoel Rindal <olemarius@olemarius.net> Last updated: 2018/10/05

% Clear up
clear all; close all;

% Read the data, poentitally download it
url='http://ustb.no/datasets/';      % if not found downloaded from here
local_path = [ustb_path(),'/data/']; % location of example data
addpath(local_path);

% Choose dataset
filename='P4_FI.uff';

% check if the file is available in the local path or downloads otherwise
tools.download(filename, url, local_path);
channel_data = uff.read_object([local_path, filename],'/channel_data');


%% Create the sector scan we want to reconstruct
scan=uff.sector_scan('azimuth_axis',...
    linspace(channel_data.sequence(1).source.azimuth,...
                channel_data.sequence(end).source.azimuth,...
                length(channel_data.sequence))',...
    'depth_axis',linspace(0,90e-3,512)');

%% Conventional Scanline Beamforming
mid = midprocess.das();
mid.channel_data=channel_data;
mid.dimension = dimension.both();
mid.scan=scan;
mid.transmit_apodization.window=uff.window.scanline;
mid.receive_apodization.window=uff.window.tukey25;
mid.receive_apodization.f_number = 1.7;

b_data = mid.go();

%%
% Display image
b_data.plot(40,['Conventional one scanline per transmit']);

%% Define scan with 8 MLA's 
MLA = 8;
scan_MLA=uff.sector_scan('azimuth_axis',...
    linspace(scan.azimuth_axis(1),scan.azimuth_axis(end),...
    scan.N_azimuth_axis*MLA)'...
    ,'depth_axis',scan.depth_axis);


%% MLA beamforming with conventional virtual source model
mid_MLA=midprocess.das();
mid_MLA.channel_data=channel_data;
mid_MLA.dimension = dimension.both();
mid_MLA.scan=scan_MLA;
mid_MLA.transmit_apodization.window=uff.window.scanline;
mid_MLA.transmit_apodization.MLA = MLA;
mid_MLA.transmit_apodization.MLA_overlap = MLA;
mid_MLA.receive_apodization.window=uff.window.tukey25;
mid_MLA.receive_apodization.f_number = 1.7;

b_data_MLA = mid_MLA.go();

%%
% Plot the image 
b_data_MLA.plot(41,['MLA image conventional virtual source model']);

%%
% Notice the artifact seen at radial distance about 50 mm from the origin,
% yes the artifact can be somewhat hard to see. It will be easier to see in
% the images that are zoomed in.

%% MLA beamforming with Nguyen & Prager model
mid_MLA_unified_fix=midprocess.das();
mid_MLA_unified_fix.channel_data=channel_data;
mid_MLA_unified_fix.dimension = dimension.both();
%By setting this we use the Prager & Nguyen model
mid_MLA_unified_fix.use_unified_fix = 1;  
mid_MLA_unified_fix.scan=scan_MLA;
mid_MLA_unified_fix.transmit_apodization.window=uff.window.scanline;
mid_MLA_unified_fix.transmit_apodization.MLA = MLA;
mid_MLA_unified_fix.transmit_apodization.MLA_overlap = MLA;
mid_MLA_unified_fix.receive_apodization.window=uff.window.tukey25;
mid_MLA_unified_fix.receive_apodization.f_number = 1.7;

b_data_MLA_unified_fix = mid_MLA_unified_fix.go();

%%
% Plot the image 
b_data_MLA_unified_fix.plot(42,['MLA image Nguyen & Prager model']);
ax(4) = gca;

%%
% Notice that the artifact is gone

%% MLA beamforming using our simple model assuming PW around focus
mid_MLA_plane_fix=midprocess.das();
mid_MLA_plane_fix.channel_data=channel_data;
mid_MLA_plane_fix.dimension = dimension.both();
%By setting this we use the simple PW model
mid_MLA_plane_fix.use_PW_fix = 1;
mid_MLA_plane_fix.margin_in_m = 4/1000;
mid_MLA_plane_fix.scan=scan_MLA;
mid_MLA_plane_fix.transmit_apodization.window=uff.window.scanline;
mid_MLA_plane_fix.transmit_apodization.MLA = MLA;
mid_MLA_plane_fix.transmit_apodization.MLA_overlap = MLA;
mid_MLA_plane_fix.receive_apodization.window=uff.window.tukey25;
mid_MLA_plane_fix.receive_apodization.f_number = 1.7;

b_data_MLA_plane_fix = mid_MLA_plane_fix.go();

%%
% Plot the image 
b_data_MLA_plane_fix.plot(43,['MLA image with PW hybrid virtual source model']);

%%
% Notice that the artifact is gone.

%% Lets have a closer look at the focal region
% Both regions fix the focal region in front of the tranducer
f100 = figure(100);
set(f100,'Position',[260     6   526   694]);
b_data.plot(subplot(4,2,1),['No MLAs']);
ax_sub_top(1) = gca;
b_data_MLA.plot(subplot(4,2,2),['MLAs virtual source']);
ax_sub_top(2) = gca;
b_data_MLA_unified_fix.plot(subplot(4,2,3),['MLAs using Nguyen & Prager']);
ax_sub_top(3) = gca;
b_data_MLA_plane_fix.plot(subplot(4,2,4),['MLAs using PW model']);
ax_sub_top(4) = gca;
linkaxes(ax_sub_top)
ylim([45 60]);xlim([-10 10]);

b_data.plot(subplot(4,2,5),['No MLAs']);
ax_sub_bottom(1) = gca;
b_data_MLA.plot(subplot(4,2,6),['MLAs virtual source']);
ax_sub_bottom(2) = gca;
b_data_MLA_unified_fix.plot(subplot(4,2,7),['MLAs using Nguyen & Prager']);
ax_sub_bottom(3) = gca;
b_data_MLA_plane_fix.plot(subplot(4,2,8),['MLAs using PW model']);
ax_sub_bottom(4) = gca;
linkaxes(ax_sub_bottom)
ylim([40 55]);xlim([15 35]);

%%
% We can observe that the artifact is removed for both the Nguyen & Prager 
% model, and our simple PW model both in front front of the probe (around x=0mm),
% and to the side (x=25mm) which was an earlier issue.

%% RTB using convetional virtual source model
mid_RTB=midprocess.das();
mid_RTB.channel_data=channel_data;
mid_RTB.dimension = dimension.both();
mid_RTB.scan=scan_MLA;
mid_RTB.transmit_apodization.window = uff.window.sector_scan_rtb;
mid_RTB.transmit_apodization.probe = channel_data.probe;
mid_RTB.receive_apodization.window = uff.window.tukey25;
mid_RTB.receive_apodization.f_number = 1.7;

b_data_RTB = mid_RTB.go();

%%
% Display image withough weighting
b_data_RTB.plot([],['RTB with virtual source model not weighted']);

%% Get the transmit apod to give the image correct weighting
tx_apod = mid_RTB.transmit_apodization.data;

x_matrix=reshape(scan_MLA.x,[scan_MLA.N_depth_axis scan_MLA.N_azimuth_axis]);
z_matrix=reshape(scan_MLA.z,[scan_MLA.N_depth_axis scan_MLA.N_azimuth_axis]);

figure(88);
pcolor(x_matrix*1e3,z_matrix*1e3,...
       reshape(tx_apod(:,51),scan_MLA.N_depth_axis,scan_MLA.N_azimuth_axis));
xlabel('x [mm]');
ylabel('z [mm]');
shading('flat');
set(gca,'fontsize',14);
set(gca,'YDir','reverse');
axis('tight','equal');
title('TX apod from sequence 51');

%%
% For illustrational purposes, we'll include a plot of the transmit
% apodization

% Calculate weights based on the transmit apod
weighting = 1./sum(tx_apod,2);

b_data_RTB_weighted = uff.beamformed_data(b_data_RTB);
b_data_RTB_weighted.data = b_data_RTB_weighted.data.*weighting;

b_data_RTB_weighted.plot(11,'RTB with virtual source model weighted');

%%
% Notice that we once again have the artifact around focus

%% RTB with Nguyen & Prager model
mid_RTB_unified_fix=midprocess.das();
mid_RTB_unified_fix.channel_data=channel_data;
mid_RTB_unified_fix.dimension = dimension.both();
mid_RTB_unified_fix.use_unified_fix = 1;
mid_RTB_unified_fix.scan=scan_MLA;
mid_RTB_unified_fix.transmit_apodization.window = uff.window.sector_scan_rtb;
mid_RTB_unified_fix.transmit_apodization.probe = channel_data.probe;
mid_RTB_unified_fix.receive_apodization.window = uff.window.tukey25;
mid_RTB_unified_fix.receive_apodization.f_number = 1.7;

b_data_RTB_unified_fix = mid_RTB_unified_fix.go();

b_data_RTB_unified_fix_weighted = uff.beamformed_data(b_data_RTB_unified_fix);
b_data_RTB_unified_fix_weighted.data = b_data_RTB_unified_fix_weighted.data.*weighting;

%%
% Plot the weighted image
b_data_RTB_unified_fix_weighted.plot(12,'RTB with Nguyen & Prager model');

%%
% Notice that the artifact around focus is removed

%% RTB with hybrid PW model
mid_RTB_PW_fix=midprocess.das();
mid_RTB_PW_fix.channel_data=channel_data;
mid_RTB_PW_fix.dimension = dimension.both();
mid_RTB_PW_fix.use_PW_fix = 1;
mid_RTB_PW_fix.margin_in_m = 4/1000;
mid_RTB_PW_fix.scan=scan_MLA;
mid_RTB_PW_fix.transmit_apodization.window = uff.window.sector_scan_rtb;
mid_RTB_PW_fix.transmit_apodization.probe = channel_data.probe;
mid_RTB_PW_fix.receive_apodization.window = uff.window.tukey25;
mid_RTB_PW_fix.receive_apodization.f_number = 1.7;

b_data_RTB_PW_fix = mid_RTB_PW_fix.go();

b_data_RTB_PW_fix_weighted = uff.beamformed_data(b_data_RTB_PW_fix);
b_data_RTB_PW_fix_weighted.data = b_data_RTB_PW_fix_weighted.data.*weighting;

b_data_RTB_PW_fix_weighted.plot(13,'RTB with hybrid PW model');

%%
% Notice that the artifact around focus is removed

%%

f200 = figure(200);
set(f200,'Position',[260     6   526   694]);
b_data.plot(subplot(4,2,1),['No RTB']);
ax_sub_top(1) = gca;
b_data_RTB_weighted.plot(subplot(4,2,2),['RTB virtual source']);
ax_sub_top(2) = gca;
b_data_RTB_unified_fix_weighted.plot(subplot(4,2,3),['RTB using Nguyen & Prager']);
ax_sub_top(3) = gca;
b_data_RTB_PW_fix_weighted.plot(subplot(4,2,4),['RTB using PW model']);
ax_sub_top(4) = gca;
linkaxes(ax_sub_top)
ylim([45 60]);xlim([-10 10]);

b_data.plot(subplot(4,2,5),['No RTB']);
ax_sub_bottom(1) = gca;
b_data_RTB_weighted.plot(subplot(4,2,6),['RTB virtual source']);
ax_sub_bottom(2) = gca;
b_data_RTB_unified_fix_weighted.plot(subplot(4,2,7),['RTB using Nguyen & Prager']);
ax_sub_bottom(3) = gca;
b_data_RTB_PW_fix_weighted.plot(subplot(4,2,8),['RTB using PW model']);
ax_sub_bottom(4) = gca;
linkaxes(ax_sub_bottom)
ylim([40 55]);xlim([15 35]);

%%
% We can observe that the artifact is removed also for RTB beamforming, 
% for both the Nguyen & Prager model, and our simple PW model both in front 
% front of the probe (around x=0mm), and to the side (x=25mm) which was an
% earlier issue. 
##### SOURCE END #####
--></body></html>