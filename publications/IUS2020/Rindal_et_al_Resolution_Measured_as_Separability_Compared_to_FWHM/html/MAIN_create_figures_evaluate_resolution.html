
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>MAIN_create_figures_evaluate_resolution</title><meta name="generator" content="MATLAB 9.8"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2020-11-24"><meta name="DC.source" content="MAIN_create_figures_evaluate_resolution.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Run script to create beampatterns</a></li><li><a href="#3">Load the data</a></li><li><a href="#4">Plot the images</a></li><li><a href="#5">Plot resolution measured as FWHM</a></li><li><a href="#6">Create plot and movie of images with displacement indicated</a></li><li><a href="#7">Measure separability</a></li><li><a href="#8">Create summary plots of separability</a></li></ul></div><pre class="codeinput"><span class="comment">% Example generating the plots in Resolution Measured as Separability Compared to Full Width Half Maximum for Adaptive Beamformers</span>
<span class="comment">% If using some of this data or code you should cite:</span>
<span class="comment">% Rindal, O. M. H., Rodriguez-Molares, A., &amp; Austeng, A. (2020). Resolution</span>
<span class="comment">% Measured as Separability Compared to Full Width Half Maximum for Adaptive</span>
<span class="comment">% Beamformers. IEEE International Ultrasonics Symposium, IUS, 1, 16&#8211;19.</span>
<span class="comment">%</span>
<span class="comment">% Abstract: Spatial resolution is defined as a system&#8217;s ability to separate</span>
<span class="comment">% targets using some kind of criterion, such as the Rayleigh criterion. However,</span>
<span class="comment">% in practice, lateral resolution is often evaluated by measuring the Full</span>
<span class="comment">% Width Half Maximum (FWHM at -6dB) of the point spread function (PSF).</span>
<span class="comment">% We hypothesize that FWHM overestimates the system resolution for some</span>
<span class="comment">% adaptive beamformers, compared to using the Rayleigh criterion.</span>
<span class="comment">% Simulation results seem to confirm this hypothesis.</span>
<span class="comment">%</span>
<span class="comment">% Author: Ole Marius Hoel Rindal &lt;olemarius@olemarius.net&gt;</span>
<span class="comment">% Date 24.11.2020</span>
</pre><h2 id="2">Run script to create beampatterns</h2><pre class="codeinput">create_beampatterns_plot
</pre><img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_01.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_02.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_03.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_04.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_05.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_06.png" alt=""> <h2 id="3">Load the data</h2><pre class="codeinput">clear <span class="string">all</span>;
close <span class="string">all</span>;
filename = [ustb_path(),<span class="string">'/data/FieldII_CPWC_point_scatterers_res_v2.uff'</span>];

b_data_das = uff.beamformed_data();
b_data_cf = uff.beamformed_data();
b_data_pcf = uff.beamformed_data();
b_data_gcf = uff.beamformed_data();
b_data_mv = uff.beamformed_data();
b_data_ebmv = uff.beamformed_data();
b_data_dmas = uff.beamformed_data();

b_data_das.read([filename],<span class="string">'/b_data_das'</span>);
b_data_cf.read([filename],<span class="string">'/b_data_cf'</span>);
b_data_pcf.read([filename],<span class="string">'/b_data_pcf'</span>);
b_data_gcf.read([filename],<span class="string">'/b_data_gcf'</span>);
b_data_mv.read([filename],<span class="string">'/b_data_mv'</span>);
b_data_ebmv.read([filename],<span class="string">'/b_data_ebmv'</span>);
b_data_dmas.read([filename],<span class="string">'/b_data_dmas'</span>);

sca = b_data_das.scan;
<span class="comment">% Separating distances used in the simulation. See</span>
separating_distance = [4 2 1 0.5 0.44 0.4];
</pre><pre class="codeoutput">UFF: reading /b_data_das [uff.beamformed_data]
UFF: reading /b_data_cf [uff.beamformed_data]
UFF: reading /b_data_pcf [uff.beamformed_data]
UFF: reading /b_data_gcf [uff.beamformed_data]
UFF: reading /b_data_mv [uff.beamformed_data]
UFF: reading /b_data_ebmv [uff.beamformed_data]
UFF: reading /b_data_dmas [uff.beamformed_data]
</pre><h2 id="4">Plot the images</h2><pre class="codeinput">b_data_das.plot([],<span class="string">'DAS'</span>);
b_data_cf.plot([],<span class="string">'CF'</span>);
b_data_pcf.plot([],<span class="string">'PCF'</span>);
b_data_gcf.plot([],<span class="string">'GCF'</span>);
b_data_mv.plot([],<span class="string">'MV'</span>);
b_data_ebmv.plot([],<span class="string">'EBMV'</span>);
b_data_dmas.plot([],<span class="string">'F-DMAS'</span>);

<span class="comment">% Get images in separate variables</span>
img{1} = b_data_das.get_image();
img{2} = b_data_cf.get_image();
img{3} = b_data_pcf.get_image();
img{4} = b_data_gcf.get_image();
img{5} = b_data_mv.get_image();
img{6} = b_data_ebmv.get_image();
img{7} = b_data_dmas.get_image();

tags{1} = <span class="string">'DAS'</span>;
tags{2} = <span class="string">'CF'</span>;
tags{3} = <span class="string">'PCF'</span>;
tags{4} = <span class="string">'GCF'</span>;
tags{5} = <span class="string">'MV'</span>;
tags{6} = <span class="string">'EBMV'</span>;
tags{7} = <span class="string">'F-DMAS'</span>;
</pre><img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_07.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_08.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_09.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_10.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_11.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_12.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_13.png" alt=""> <h2 id="5">Plot resolution measured as FWHM</h2><pre class="codeinput">img_none{1} = b_data_das.get_image(<span class="string">'none'</span>);
img_none{2} = b_data_cf.get_image(<span class="string">'none'</span>);
img_none{3} = b_data_pcf.get_image(<span class="string">'none'</span>);
img_none{4} = b_data_gcf.get_image(<span class="string">'none'</span>);
img_none{5} = b_data_mv.get_image(<span class="string">'none'</span>);
img_none{6} = b_data_ebmv.get_image(<span class="string">'none'</span>);
img_none{7} = b_data_dmas.get_image(<span class="string">'none'</span>);

f = figure(88);clf;
clear <span class="string">res</span>;
<span class="keyword">for</span> m = 1:7
    format <span class="string">long</span>
    lateral =  img{m}(103,:,1);

    [res(m)] = calculate_6dB_resolution(sca.x_axis*10^3,lateral,1,88,m);

    ylim(gca,[-30 0])
    xlim(gca,[-1 1])
    set(gca,<span class="string">'FontSize'</span>,15);
<span class="keyword">end</span>

subplot(2,7,[8:14]);
bar(1:7,res)
xlim([0.5 7.5])
ylabel(<span class="string">'FWHM [mm]'</span>);
xticks(1:7)
xticklabels(tags)
set(gca,<span class="string">'FontSize'</span>,13);
set(gcf,<span class="string">'Position'</span>,[10 163 1454 464])
saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'FWHM_res_v2'</span>],<span class="string">'eps2c'</span>)
saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'FWHM_res_v2'</span>],<span class="string">'png'</span>)
</pre><img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_14.png" alt=""> <h2 id="6">Create plot and movie of images with displacement indicated</h2><pre class="codeinput">frames = [1 2 3 4 5 6 7];

FileName = <span class="string">'movie_res.mp4'</span>;
vidObj = VideoWriter([FileName],<span class="string">'MPEG-4'</span>);
vidObj.Quality = 100;
vidObj.FrameRate = 1;
open(vidObj);

idx = 1;
<span class="keyword">for</span> i = frames
    f = figure(100+i);clf;
    <span class="keyword">for</span> m = 1:7
        subplot(3,7,m)
        imagesc(sca.x_axis*1000,sca.z_axis*1000,img{m}(:,:,i))
        ax(m) = gca;
        axis <span class="string">image</span>;colormap <span class="string">gray</span>;caxis([-60 0])
        title(tags{m});
        xlabel(<span class="string">'x [mm]'</span>);
        <span class="keyword">if</span>(m == 1)
        ylabel(<span class="string">'y [mm]'</span>);
        <span class="keyword">end</span>
        set(gca,<span class="string">'FontSize'</span>,15)

        subplot(3,7,[8:21]); hold <span class="string">all</span>;
        plot(sca.x_axis*1000,img{m}(105,:,i)-max(img{m}(105,:,i)),<span class="string">'DisplayName'</span>,tags{m},<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{m})
        xlim([-2 2])
        ylim([-60 0])
        xlabel(<span class="string">'x [mm]'</span>);
        ylabel(<span class="string">'Amplitude [dB]'</span>);
    <span class="keyword">end</span>
    subplot(3,7,[8:21]); hold <span class="string">all</span>;
    plot(sca.x_axis*1000,ones(1,length(sca.x_axis))*-6,<span class="string">'r--'</span>,<span class="string">'DisplayName'</span>,tags{m},<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,<span class="string">'-6 dB'</span>)
    linkaxes(ax);
    legend <span class="string">show</span>
    set(gcf,<span class="string">'Position'</span>,[46 50 1083 750]);
    set(gca,<span class="string">'FontSize'</span>,20)

<span class="keyword">if</span> i == 1
    mkdir([ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>])
    saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'FWHM_PSF_v2'</span>],<span class="string">'eps2c'</span>)
    saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'FWHM_PSF_v2'</span>],<span class="string">'png'</span>)

<span class="keyword">else</span>
    saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'FWHM_PSF_'</span>,strrep(num2str(separating_distance(idx)),<span class="string">'.'</span>,<span class="string">'_'</span>),<span class="string">'_v2'</span>],<span class="string">'eps2c'</span>)
    saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'FWHM_PSF_'</span>,strrep(num2str(separating_distance(idx)),<span class="string">'.'</span>,<span class="string">'_'</span>),<span class="string">'_v2'</span>],<span class="string">'png'</span>)

    idx = idx+1;
    drawnow();
    writeVideo(vidObj, getframe(f));
<span class="keyword">end</span>
<span class="keyword">end</span>
close(vidObj)
</pre><pre class="codeoutput">Warning: Directory already exists. 
</pre><img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_15.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_16.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_17.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_18.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_19.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_20.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_21.png" alt=""> <h2 id="7">Measure separability</h2><pre class="codeinput">clear <span class="string">separability</span>;
frames = [2:7];
<span class="keyword">for</span> i = frames
    <span class="comment">%figure(101+i);clf;hold all;</span>
    <span class="keyword">for</span> m= 1:7
        normalized_lateral{m} =  img{m}(105,:,i)-max(img{m}(105,:,i));

        [dummy,idx_start] = min(abs(sca.x_axis*1000-(-2.5)));
        [dummy,idx_stop] = min(abs(sca.x_axis*1000-(1)));
        [dummy,idx_zero] = min(abs(sca.x_axis*1000));
        min_value = normalized_lateral{m}(idx_zero);
        [max_value,idx_max] = max(normalized_lateral{m}(idx_start:idx_stop));

        <span class="comment">%plot(sca.x_axis(idx_start:idx_stop)*1000,normalized_lateral{m}(idx_start:idx_stop));</span>
        <span class="comment">%plot(sca.x_axis(idx_start+idx_max-1)*1000,max_value,'*');</span>
        <span class="comment">%plot(sca.x_axis(idx_zero)*1000,min_value,'*');</span>

        separability(m,i-1) = max_value-min_value;
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2 id="8">Create summary plots of separability</h2><pre class="codeinput">separability_lim = 6;

f = figure;
subplot(211);hold <span class="string">all</span>;
plot(separability(1,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{1})
plot(separability(2,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{2})
plot(separability(3,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{3})
plot(separability(4,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{4})
plot(separability(5,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{5})
plot(separability(6,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{6})
plot(separability(7,:),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{7})
plot([1:7],ones(7,1)*separability_lim,<span class="string">'LineWidth'</span>,2,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'LineStyle'</span>,<span class="string">'--'</span>,<span class="string">'DisplayName'</span>,<span class="string">'6 dB limit'</span>)
legend <span class="string">show</span>
xlim([1 9])
xticks([1:6])
xticklabels({num2str(separating_distance(1)) num2str(separating_distance(2)) num2str(separating_distance(3)) num2str(separating_distance(4)) num2str(separating_distance(5)) num2str(separating_distance(6))})
xlabel(<span class="string">'Distance between scatterers [mm]'</span>)
ylabel(<span class="string">'Separability [dB]'</span>);
set(gca,<span class="string">'FontSize'</span>,12)
saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'separability_1'</span>],<span class="string">'eps2c'</span>)

f = figure;
subplot(212);hold <span class="string">all</span>;
plot((separability(1,:)&gt;separability_lim)-0.15,<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{1})
plot((separability(2,:)&gt;separability_lim)-0.1,<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{2})
plot((separability(3,:)&gt;separability_lim)-0.05,<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{3})
plot((separability(4,:)&gt;separability_lim),<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{4})
plot((separability(5,:)&gt;separability_lim)+0.05,<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{5})
plot((separability(6,:)&gt;separability_lim)+0.1,<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{6})
plot((separability(7,:)&gt;separability_lim)+0.15,<span class="string">'-*'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'DisplayName'</span>,tags{7})
ylim([-0.5 1.5])
xticks([1:6])
xticklabels({num2str(separating_distance(1)) num2str(separating_distance(2)) num2str(separating_distance(3)) num2str(separating_distance(4)) num2str(separating_distance(5)) num2str(separating_distance(6))})
xlabel(<span class="string">'Distance between scatterers [mm]'</span>)
xlim([1 9])
yticks([0 1])
yticklabels({<span class="string">'Not separated'</span>,<span class="string">'Separated'</span>})
set(gca,<span class="string">'FontSize'</span>,12)
legend(<span class="string">'show'</span>)
saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'separability_2'</span>],<span class="string">'eps2c'</span>)
saveas(f,[ustb_path,filesep,<span class="string">'publications'</span>,filesep,<span class="string">'IUS2020'</span>,filesep,<span class="string">'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM'</span>,filesep,<span class="string">'figures'</span>,filesep,<span class="string">'separability_2'</span>],<span class="string">'png'</span>)
</pre><img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_22.png" alt=""> <img vspace="5" hspace="5" src="MAIN_create_figures_evaluate_resolution_23.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2020a</a><br></p></div><!--
##### SOURCE BEGIN #####
% Example generating the plots in Resolution Measured as Separability Compared to Full Width Half Maximum for Adaptive Beamformers
% If using some of this data or code you should cite: 
% Rindal, O. M. H., Rodriguez-Molares, A., & Austeng, A. (2020). Resolution
% Measured as Separability Compared to Full Width Half Maximum for Adaptive 
% Beamformers. IEEE International Ultrasonics Symposium, IUS, 1, 16–19.
% 
% Abstract: Spatial resolution is defined as a system’s ability to separate 
% targets using some kind of criterion, such as the Rayleigh criterion. However, 
% in practice, lateral resolution is often evaluated by measuring the Full 
% Width Half Maximum (FWHM at -6dB) of the point spread function (PSF).
% We hypothesize that FWHM overestimates the system resolution for some
% adaptive beamformers, compared to using the Rayleigh criterion. 
% Simulation results seem to confirm this hypothesis.
%
% Author: Ole Marius Hoel Rindal <olemarius@olemarius.net>
% Date 24.11.2020

%% Run script to create beampatterns
create_beampatterns_plot

%% Load the data
clear all;
close all;
filename = [ustb_path(),'/data/FieldII_CPWC_point_scatterers_res_v2.uff'];

b_data_das = uff.beamformed_data();
b_data_cf = uff.beamformed_data();
b_data_pcf = uff.beamformed_data();
b_data_gcf = uff.beamformed_data();
b_data_mv = uff.beamformed_data();
b_data_ebmv = uff.beamformed_data();
b_data_dmas = uff.beamformed_data();

b_data_das.read([filename],'/b_data_das');
b_data_cf.read([filename],'/b_data_cf');
b_data_pcf.read([filename],'/b_data_pcf');
b_data_gcf.read([filename],'/b_data_gcf');
b_data_mv.read([filename],'/b_data_mv');
b_data_ebmv.read([filename],'/b_data_ebmv');
b_data_dmas.read([filename],'/b_data_dmas');

sca = b_data_das.scan;
% Separating distances used in the simulation. See 
separating_distance = [4 2 1 0.5 0.44 0.4];

%% Plot the images
b_data_das.plot([],'DAS');
b_data_cf.plot([],'CF');
b_data_pcf.plot([],'PCF');
b_data_gcf.plot([],'GCF');
b_data_mv.plot([],'MV');
b_data_ebmv.plot([],'EBMV');
b_data_dmas.plot([],'F-DMAS');

% Get images in separate variables
img{1} = b_data_das.get_image();
img{2} = b_data_cf.get_image();
img{3} = b_data_pcf.get_image();
img{4} = b_data_gcf.get_image();
img{5} = b_data_mv.get_image();
img{6} = b_data_ebmv.get_image();
img{7} = b_data_dmas.get_image();

tags{1} = 'DAS';
tags{2} = 'CF';
tags{3} = 'PCF';
tags{4} = 'GCF';
tags{5} = 'MV';
tags{6} = 'EBMV';
tags{7} = 'F-DMAS';

%% Plot resolution measured as FWHM
img_none{1} = b_data_das.get_image('none');
img_none{2} = b_data_cf.get_image('none');
img_none{3} = b_data_pcf.get_image('none');
img_none{4} = b_data_gcf.get_image('none');
img_none{5} = b_data_mv.get_image('none');
img_none{6} = b_data_ebmv.get_image('none');
img_none{7} = b_data_dmas.get_image('none');

f = figure(88);clf;
clear res;
for m = 1:7
    format long
    lateral =  img{m}(103,:,1);
    
    [res(m)] = calculate_6dB_resolution(sca.x_axis*10^3,lateral,1,88,m);
    
    ylim(gca,[-30 0])
    xlim(gca,[-1 1])
    set(gca,'FontSize',15);
end

subplot(2,7,[8:14]);
bar(1:7,res)
xlim([0.5 7.5])
ylabel('FWHM [mm]');
xticks(1:7)
xticklabels(tags)
set(gca,'FontSize',13);
set(gcf,'Position',[10 163 1454 464])
saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'FWHM_res_v2'],'eps2c')  
saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'FWHM_res_v2'],'png')  

%% Create plot and movie of images with displacement indicated
frames = [1 2 3 4 5 6 7];

FileName = 'movie_res.mp4';
vidObj = VideoWriter([FileName],'MPEG-4');
vidObj.Quality = 100;
vidObj.FrameRate = 1;
open(vidObj);

idx = 1;
for i = frames
    f = figure(100+i);clf;
    for m = 1:7
        subplot(3,7,m)
        imagesc(sca.x_axis*1000,sca.z_axis*1000,img{m}(:,:,i))
        ax(m) = gca;
        axis image;colormap gray;caxis([-60 0])
        title(tags{m});
        xlabel('x [mm]');
        if(m == 1)
        ylabel('y [mm]');
        end
        set(gca,'FontSize',15)
        
        subplot(3,7,[8:21]); hold all;
        plot(sca.x_axis*1000,img{m}(105,:,i)-max(img{m}(105,:,i)),'DisplayName',tags{m},'LineWidth',2,'DisplayName',tags{m})
        xlim([-2 2])
        ylim([-60 0])
        xlabel('x [mm]');
        ylabel('Amplitude [dB]');
    end
    subplot(3,7,[8:21]); hold all;
    plot(sca.x_axis*1000,ones(1,length(sca.x_axis))*-6,'rREPLACE_WITH_DASH_DASH','DisplayName',tags{m},'LineWidth',2,'DisplayName','-6 dB')
    linkaxes(ax);
    legend show
    set(gcf,'Position',[46 50 1083 750]);
    set(gca,'FontSize',20)

if i == 1
    mkdir([ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures'])
    saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'FWHM_PSF_v2'],'eps2c')
    saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'FWHM_PSF_v2'],'png')

else
    saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'FWHM_PSF_',strrep(num2str(separating_distance(idx)),'.','_'),'_v2'],'eps2c')  
    saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'FWHM_PSF_',strrep(num2str(separating_distance(idx)),'.','_'),'_v2'],'png')  
 
    idx = idx+1;
    drawnow();
    writeVideo(vidObj, getframe(f));
end
end
close(vidObj)


%% Measure separability 
clear separability;
frames = [2:7];
for i = frames
    %figure(101+i);clf;hold all;
    for m= 1:7
        normalized_lateral{m} =  img{m}(105,:,i)-max(img{m}(105,:,i));
        
        [dummy,idx_start] = min(abs(sca.x_axis*1000-(-2.5)));
        [dummy,idx_stop] = min(abs(sca.x_axis*1000-(1)));
        [dummy,idx_zero] = min(abs(sca.x_axis*1000));
        min_value = normalized_lateral{m}(idx_zero);
        [max_value,idx_max] = max(normalized_lateral{m}(idx_start:idx_stop));
        
        %plot(sca.x_axis(idx_start:idx_stop)*1000,normalized_lateral{m}(idx_start:idx_stop));
        %plot(sca.x_axis(idx_start+idx_max-1)*1000,max_value,'*');
        %plot(sca.x_axis(idx_zero)*1000,min_value,'*');
        
        separability(m,i-1) = max_value-min_value;
    end
end


%% Create summary plots of separability
separability_lim = 6; 

f = figure;
subplot(211);hold all;
plot(separability(1,:),'-*','LineWidth',2,'DisplayName',tags{1})
plot(separability(2,:),'-*','LineWidth',2,'DisplayName',tags{2})
plot(separability(3,:),'-*','LineWidth',2,'DisplayName',tags{3})
plot(separability(4,:),'-*','LineWidth',2,'DisplayName',tags{4})
plot(separability(5,:),'-*','LineWidth',2,'DisplayName',tags{5})
plot(separability(6,:),'-*','LineWidth',2,'DisplayName',tags{6})
plot(separability(7,:),'-*','LineWidth',2,'DisplayName',tags{7})
plot([1:7],ones(7,1)*separability_lim,'LineWidth',2,'Color','r','LineStyle','REPLACE_WITH_DASH_DASH','DisplayName','6 dB limit')
legend show
xlim([1 9])
xticks([1:6])
xticklabels({num2str(separating_distance(1)) num2str(separating_distance(2)) num2str(separating_distance(3)) num2str(separating_distance(4)) num2str(separating_distance(5)) num2str(separating_distance(6))})
xlabel('Distance between scatterers [mm]')
ylabel('Separability [dB]');
set(gca,'FontSize',12)
saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'separability_1'],'eps2c')  

f = figure;
subplot(212);hold all;
plot((separability(1,:)>separability_lim)-0.15,'-*','LineWidth',2,'DisplayName',tags{1})
plot((separability(2,:)>separability_lim)-0.1,'-*','LineWidth',2,'DisplayName',tags{2})
plot((separability(3,:)>separability_lim)-0.05,'-*','LineWidth',2,'DisplayName',tags{3})
plot((separability(4,:)>separability_lim),'-*','LineWidth',2,'DisplayName',tags{4})
plot((separability(5,:)>separability_lim)+0.05,'-*','LineWidth',2,'DisplayName',tags{5})
plot((separability(6,:)>separability_lim)+0.1,'-*','LineWidth',2,'DisplayName',tags{6})
plot((separability(7,:)>separability_lim)+0.15,'-*','LineWidth',2,'DisplayName',tags{7})
ylim([-0.5 1.5])
xticks([1:6])
xticklabels({num2str(separating_distance(1)) num2str(separating_distance(2)) num2str(separating_distance(3)) num2str(separating_distance(4)) num2str(separating_distance(5)) num2str(separating_distance(6))})
xlabel('Distance between scatterers [mm]')
xlim([1 9])
yticks([0 1])
yticklabels({'Not separated','Separated'})
set(gca,'FontSize',12)
legend('show')
saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'separability_2'],'eps2c')  
saveas(f,[ustb_path,filesep,'publications',filesep,'IUS2020',filesep,'Rindal_et_al_Resolution_Measured_as_Separability_Compared_to_FWHM',filesep,'figures',filesep,'separability_2'],'png')  


##### SOURCE END #####
--></body></html>